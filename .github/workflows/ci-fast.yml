name: CI - Fast Checks

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-test:
    name: ${{ matrix.os }} - Debug - Unit Tests
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, windows-latest]
        include:
          - os: ubuntu-24.04
            triplet: x64-linux
            cc: gcc-13
            cxx: g++-13
          - os: windows-latest
            triplet: x64-windows-static
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install vcpkg (Windows)
      if: runner.os == 'Windows'
      run: |
        git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
        C:\vcpkg\bootstrap-vcpkg.bat
        echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
    
    - name: Install vcpkg (Linux)
      if: runner.os == 'Linux'
      run: |
        git clone https://github.com/Microsoft/vcpkg.git $HOME/vcpkg
        $HOME/vcpkg/bootstrap-vcpkg.sh
        echo "VCPKG_ROOT=$HOME/vcpkg" >> $GITHUB_ENV
    
    - name: Install GCC 13 (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13 ninja-build
    
    - name: Configure CMake (Linux)
      if: runner.os == 'Linux'
      run: |
        CC=gcc-13 CXX=g++-13 cmake -S . -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_TOOLCHAIN_FILE=$HOME/vcpkg/scripts/buildsystems/vcpkg.cmake \
          -DVCPKG_TARGET_TRIPLET=x64-linux \
          -DORION_BUILD_TESTS=ON
    
    - name: Configure CMake (Windows)
      if: runner.os == 'Windows'
      run: |
        cmake -S . -B build `
          -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_TOOLCHAIN_FILE="C:\vcpkg\scripts\buildsystems\vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET=x64-windows-static `
          -DORION_BUILD_TESTS=ON
    
    - name: Build (Linux)
      if: runner.os == 'Linux'
      run: cmake --build build -j$(nproc)
    
    - name: Build (Windows)
      if: runner.os == 'Windows'
      run: cmake --build build --config Debug --parallel
    
    - name: Run Unit Tests (Linux)
      if: runner.os == 'Linux'
      run: ./build/tst_orion --log_level=test_suite
      working-directory: ${{ github.workspace }}
    
    - name: Run Unit Tests (Windows)
      if: runner.os == 'Windows'
      run: .\build\Debug\tst_orion.exe --log_level=test_suite
      working-directory: ${{ github.workspace }}
