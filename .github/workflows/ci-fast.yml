name: CI - Fast Checks

on:
  push:
    branches: [ "**" ]
    paths-ignore:
      - 'docs/**'
      - '.github/tasks/**'
      - '**/*.md'
      - 'LICENSE'
      - 'NOTICE'
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - 'docs/**'
      - '.github/tasks/**'
      - '**/*.md'
      - 'LICENSE'
      - 'NOTICE'
  workflow_dispatch:

jobs:
  build-and-test:
    name: ${{ matrix.os }} - Debug - Unit Tests
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, windows-latest]
        include:
          - os: ubuntu-24.04
            triplet: x64-linux
            cc: gcc-13
            cxx: g++-13
          - os: windows-latest
            triplet: x64-windows-static
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          C:\Users\runneradmin\AppData\Local\vcpkg\archives
          ~/.cache/vcpkg
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-
    
    - name: Install vcpkg (Windows)
      if: runner.os == 'Windows'
      run: |
        New-Item -ItemType Directory -Force -Path "C:\Users\runneradmin\AppData\Local\vcpkg\archives"
        git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
        C:\vcpkg\bootstrap-vcpkg.bat
        echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
        echo "VCPKG_DEFAULT_BINARY_CACHE=C:\Users\runneradmin\AppData\Local\vcpkg\archives" >> $env:GITHUB_ENV
    
    - name: Install vcpkg (Linux)
      if: runner.os == 'Linux'
      run: |
        mkdir -p $HOME/.cache/vcpkg
        git clone https://github.com/Microsoft/vcpkg.git $HOME/vcpkg
        $HOME/vcpkg/bootstrap-vcpkg.sh
        echo "VCPKG_ROOT=$HOME/vcpkg" >> $GITHUB_ENV
        echo "VCPKG_DEFAULT_BINARY_CACHE=$HOME/.cache/vcpkg" >> $GITHUB_ENV
    
    - name: Install GCC 13 (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-13 g++-13 ninja-build
    
    - name: Configure CMake (Linux)
      if: runner.os == 'Linux'
      run: |
        CC=gcc-13 CXX=g++-13 cmake -S . -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_TOOLCHAIN_FILE=$HOME/vcpkg/scripts/buildsystems/vcpkg.cmake \
          -DVCPKG_TARGET_TRIPLET=x64-linux \
          -DORION_BUILD_TESTS=ON
    
    - name: Configure CMake (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cmake -S . -B build ^
          -G Ninja ^
          -DCMAKE_BUILD_TYPE=Debug ^
          -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake ^
          -DVCPKG_TARGET_TRIPLET=x64-windows-static ^
          -DORION_BUILD_TESTS=ON
    
    - name: Build (Linux)
      if: runner.os == 'Linux'
      run: cmake --build build -j$(nproc)
    
    - name: Build (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cmake --build build --parallel
    
    - name: Run Unit Tests (Linux)
      if: runner.os == 'Linux'
      run: ./build/tst_orion --log_level=test_suite
      working-directory: ${{ github.workspace }}
      env:
        ORION_TCK_RUN_ALL: 0
    
    - name: Run Unit Tests (Windows)
      if: runner.os == 'Windows'
      run: .\build\tst_orion.exe --log_level=test_suite
      working-directory: ${{ github.workspace }}
      env:
        ORION_TCK_RUN_ALL: 0
